#! /bin/bash

# This source file is part of the Swift.org open source project
#
# Copyright (c) 2024 Apple Inc. and the Swift project authors
# Licensed under Apache License v2.0 with Runtime Library Exception
#
# See https://swift.org/LICENSE.txt for license information
# See https://swift.org/CONTRIBUTORS.txt for Swift project authors

# Builds the PDF version of The Swift Programming Language using Typst.
# This script handles the conversion from DocC to Typst and the compilation process.

set -eux

# Start at the top level directory of the repository.
cd "$(git rev-parse --show-toplevel)"

echo "Starting Swift Book PDF build..."

# 1. Check Prerequisites
if ! command -v typst &> /dev/null; then
    echo "Error: 'typst' is not installed."
    echo "Please install Typst: https://github.com/typst/typst"
    exit 1
fi

# 2. Setup Environment
echo "Setting up dependencies..."

# Determine Typst Data Directory
if [[ "$OSTYPE" == "darwin"* ]]; then
  TYPST_DATA_DIR="$HOME/Library/Application Support/typst"
else
  # Default to XDG or Linux standard
  TYPST_DATA_DIR="${XDG_DATA_HOME:-$HOME/.local/share}/typst"
fi

# Define where local packages live
PACKAGE_DIR="$TYPST_DATA_DIR/packages/local/eightbyten/0.2.0"

# Clean/Create package directory
if [ ! -d "$PACKAGE_DIR" ]; then
    echo "Downloading eightbyten package..."
    mkdir -p "$PACKAGE_DIR"
    # Clone specific version
    git clone --depth 1 --branch v0.2.0 https://github.com/peterfriese/eightbyten.git "$PACKAGE_DIR"
else
    echo "Updating eightbyten package..."
    # Optional: git -C "$PACKAGE_DIR" pull
fi

# Note: We rely on standard Typst discovery, so no need to export TYPST_PACKAGE_PATH
# export TYPST_PACKAGE_PATH="${TYPST_PACKAGE_PATH:-$PWD/packages}"

# Check for Gemini API Key (Optional but recommended)
if [[ -z "${GEMINI_API_KEY:-}" ]]; then
    echo "----------------------------------------------------------------"
    echo "NOTICE: GEMINI_API_KEY is not set."
    echo "AI-generated chapter eyebrows will be disabled and fallback heuristics used."
    echo ""
    echo "To enable AI features:"
    echo "  - Local: export GEMINI_API_KEY='your-key'"
    echo "  - GitHub: Add GEMINI_API_KEY to Repository Secrets"
    echo "----------------------------------------------------------------"
fi

# 3. Check Python Dependencies
if ! python3 -c "import requests" &> /dev/null; then
    echo "Installing required Python package: requests..."
    pip3 install requests --user
fi

# 4. Migration
echo "Converting DocC content to Typst..."
mkdir -p generated/chapters/Assets
bin/migrate-docs

# 5. Font Check
FONT_DIR="fonts"
if [ ! -d "$FONT_DIR" ] || [ -z "$(ls -A "$FONT_DIR")" ]; then
    echo "Downloading IBM Plex fonts..."
    mkdir -p "$FONT_DIR"
    # Download IBM Plex TrueType zip
    curl -L -o plex.zip https://github.com/IBM/plex/releases/download/v6.4.0/TrueType.zip
    # Unzip specifically the files we need (or all) into a temp dir
    unzip -o -q plex.zip -d plex_tmp
    # Move TTF files to fonts dir (flatten structure)
    find plex_tmp -name "*.ttf" -exec mv {} "$FONT_DIR/" \;
    # Cleanup
    rm -rf plex.zip plex_tmp
fi

# 6. Compilation
echo "Compiling PDF..."
OUTPUT_FILE="${1:-swift-book.pdf}"

typst compile book-layout/main.typ "$OUTPUT_FILE" --root . --font-path "$FONT_DIR"

echo "Build complete: $OUTPUT_FILE"
